<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="/redux-mixin.html">
<link rel="import" href="../mixins/ff-shop-mixin.html">

<dom-module id="ff-shop-states">
  <template>
    <iron-ajax
      id="inn"
      url="[[importPath]]json/inn.json"
      last-response="{{ innShopStates }}"
      auto></iron-ajax>
  </template>

  <script>
    class ShopStatesElement extends ShopMixin(ReduxMixin(Polymer.Element)) {
      static get is() { return 'ff-shop-states'; }

      static get properties() {
        return {
          partyInventoryKey: {
            notify: true,
            type: String,
          },
          shop: {
            statePath: 'shop.type',
            type: String
          },
          statesByShop: {
            readonly: true,
            type: Object
          },
          shopState: {
            notify: true,
            type: Object,
          },
          sign: {
            notify: true,
            type: String
          },
          stateId: {
            type: String
          }
        };
      }

      static get observers() {
        return [
          '_loadState(shop, stateId, statesByShop)',
          '_setupShop(innShopStates)',
          '_shopChanged(shop, statesByShop)'
        ];
      }

      ready() {
        super.ready();

        //this._setupInn();
        //this._setupItemShop();
        //this._setupWeaponShop();
      }

      _equipmentStates() {
        return {
          start: {
            back: 'exit',
            conversation: ['Welcome'],
            choices: [
              { label: 'Buy', to: 'buyingStart' },
              { label: 'Sell', to: 'sellingStart' },
              { label: 'Exit', to: 'exit' }
            ],
            reset: true
          },
          buyingStart: {
            back: 'start',
            conversation: ['What do', 'you', 'want?'],
            inventoryActive: 'shop',
            showInventory: true,
            to: 'buyingConfirmPrice'
          },
          buyingConfirmPrice: {
            askForPrice: true,
            back: 'regretStart',
            choices: [
              { label: 'Yes', to: 'buyingForWhom' },
              { label: 'No', to: 'regretStart' }
            ],
            showInventory: true
          },
          buyingForWhom: {
            back: 'regretStart',
            charNameChoices: true,
            conversation: ['Who', 'will', 'take', 'it?'],
            finishTransaction: true,
            maxAllowed: 4,
            showInventory: true,
            to: 'thanks',
            transactionChecks: ['money', 'room']
          },
          sellingStart: {
            back: 'regretStart',
            charNameChoices: true,
            checkCharInventory: true,
            conversation: ['Whose', 'item', 'do you', 'want to', 'sell?'],
            sale: true,
            to: 'sellingFromWhom',
            transactionChecks: ['anythingToSell']
          },
          sellingFromWhom: {
            back: 'regretStart',
            conversation: ['Whose', 'item', 'do you', 'want to', 'sell?'],
            inventoryActive: 'char',
            showCharInventory: true,
            to: 'sellingConfirmPrice'
          },
          sellingConfirmPrice: {
            askForPrice: true,
            back: 'regretStart',
            choices: [
              { label: 'Yes', to: 'thanks' },
              { label: 'No', to: 'regretStart' }
            ],
            confirmPurchase: true,
            finishTransaction: true,
            showCharInventory: true
          },
          notEnoughMoney: {
            conversation: ['You', 'can\'t', 'afford', 'that.'],
            copyFrom: 'start'
          },
          notEnoughRoom: {
            conversation: ['You', 'can\'t', 'carry', 'anymore'],
            copyFrom: 'start'
          },
          nothingToSell: {
            conversation: ['You', 'have', 'nothing', 'to sell', '  ::', 'Any-', 'thing', 'else?'],
            copyFrom: 'start'
          },
          regretStart: {
            conversation: ['Too bad', '::', 'Some-', 'thing', 'else?'],
            copyFrom: 'start'
          },
          thanks: {
            conversation: ['Thank', 'you!', 'What', 'else?'],
            copyFrom: 'start'
          }
        };
      }

      _setupItemShop() {
        this._shopSetup({
          id: this.ShopIds.Item,
          sign: 'ITEM',
          states: {
            start: {
              back: 'exit',
              conversation: ['Welcome'],
              choices: [
                { label: 'Buy', to: 'buyingStart' },
                { label: 'Exit', to: 'exit' }
              ],
              partyInventory: true,
              reset: true
            },
            buyingStart: {
              back: 'start',
              conversation: ['What do', 'you', 'want?'],
              inventoryActive: 'shop',
              showInventory: true,
              to: 'buyingConfirmPrice'
            },
            buyingConfirmPrice: {
              askForPrice: true,
              back: 'regretStart',
              choices: [
                { label: 'Yes', to: 'thanks' },
                { label: 'No', to: 'regretStart' }
              ],
              finishTransaction: true,
              showInventory: true,
              transactionChecks: ['money']
            },
            notEnoughMoney: {
              conversation: ['You', 'can\'t', 'afford', 'that.'],
              copyFrom: 'start',
              showInventory: true
            },
            regretStart: {
              conversation: ['Too bad', '::', 'Some-', 'thing', 'else?'],
              copyFrom: 'start',
              showInventory: true
            },
            thanks: {
              conversation: ['Thank', 'you!', 'What', 'else?'],
              copyFrom: 'start',
              showInventory: true
            }
          }
        });
      }

      _setupInn() {
        this._shopSetup();
      }

      _setupWeaponShop() {
        this._shopSetup({
          id: this.ShopIds.Weapon,
          sign: 'WEAPON',
          partyInventoryKey: 'weapons',
          states: Object.assign({}, this._equipmentStates())
        });
      }

      _loadShop(shopType) {
        const shop = this.statesByShop[shopType];
        if (!shop) {
          throw `No shop found for type [${shopType}]`
        }
        return shop;
      }

      _loadState(shopType, stateId) {
        if (!shopType || !stateId || !this.statesByShop) {
          return;
        }

        if (stateId === 'exit') {
          this.set('shopState', { exit: true });
          return;
        }

        this.set('shopState', this._loadShop(shopType).states[stateId]);
      }

      _shopChanged(shopType, statesByShop) {
        if (!shopType || !statesByShop) {
          return;
        }

        const shop = this._loadShop(shopType);
        this.set('sign', shop.sign);
        this.set('partyInventoryKey', shop.partyInventoryKey);
        this._loadState(shopType, 'start');
      }

      _setupShop(...shopData) {
        this.set('statesByShop', shopData.reduce((byId, shopStates) => {
          byId[shopStates.id] = Object.assign({}, shopStates);
          let states = byId[shopStates.id].states;
          Object.keys(states).forEach(stateId => {
            let state = states[stateId];
            if (state.copyFrom) {
              states[stateId] = Object.assign({}, states[state.copyFrom], state);
            }
          });
          return byId;
        }, {}));
      }
    }

    customElements.define(ShopStatesElement.is, ShopStatesElement);
  </script>
</dom-module>