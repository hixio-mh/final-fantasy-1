<link rel="import" href="/bower_components/polymer/polymer-element.html">
<link rel="import" href="/bower_components/iron-ajax/iron-ajax.html">

<dom-module id="ff-data">
  <template>
    <iron-ajax
      id="armor"
      url="../json/armor.json"
      last-response="{{ armorById }}"></iron-ajax>
    <iron-ajax
      id="black-magic"
      url="../json/black-magic.json"
      last-response="{{ blackMagicById }}"></iron-ajax>
    <iron-ajax
      id="items"
      url="../json/items.json"
      last-response="{{ itemsById }}"></iron-ajax>
    <iron-ajax
      id="statuses"
      url="../json/statuses.json"
      last-response="{{ statusesById }}"></iron-ajax>
    <iron-ajax
      id="weapons"
      url="../json/weapons.json"
      last-response="{{ weaponsById }}"></iron-ajax>
    <iron-ajax
      id="white-magic"
      url="../json/white-magic.json"
      last-response="{{ whiteMagicById }}"></iron-ajax>
  </template>

  <script>
    class DataElement extends Polymer.Element {
      static get is() { return 'ff-data'; }

      static get properties() {
        return {
          data: {
            notify: true,
            type: Object,
            value: {}
          },
          fetch: {
            observer: '_fetchChanged',
            type: String
          }
        };
      }

      static get observers() {
        return [
          '_dataChanged(armorById, blackMagicById, itemsById, statusesById, weaponsById, whiteMagicById)'
        ];
      }

      _addToData(data, byId, key) {
        if (byId) {
          data[key] = {
            all: this._all(byId),
            byId: byId
          }
        }
      }

      _all(byId) {
        return Object.keys(byId).map(id => Object.assign({ id }, byId[id]));
      }

      _dataChanged(armorById, blackMagicById, itemsById, statusesById, weaponsById, whiteMagicById) {
        let updated = Object.assign({}, this.data);
        this._addToData(updated, armorById, 'armor');
        this._addToData(updated, blackMagicById, 'blackMagic');
        this._addToData(updated, itemsById, 'items');
        this._addToData(updated, statusesById, 'statuses');
        this._addToData(updated, weaponsById, 'weapons');
        this._addToData(updated, whiteMagicById, 'whiteMagic');
        this.set('data', updated);
      }

      _fetchChanged(newValue, oldValue) {
        if (!newValue) {
          return;
        }

        newValue.split(' ').forEach(d => this.$[d].generateRequest());
      }
    }

    customElements.define(DataElement.is, DataElement);
  </script>
</dom-module>