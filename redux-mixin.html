<link rel="import" href="/bower_components/polymer-redux/polymer-redux.html">
<script src="/node_modules/redux/dist/redux.js"></script>

<script>
(() => {
  const initialState = {
    map: null,
    mapId: '',
    movableId: '',
    moving: [],
    party: [],
    partyVehicles: ['Foot'],
    position: { x: -1, y: -1 },
    screen: 'openingMenu',
    vehicle: 'Foot',
    vehiclePositions: {
      Ship: { x: -1, y: -1 },
      Airship: { x: -1, y: -1 }
    },
    worldMapPosition: { x: 153, y: 165 }
  };

  const isWorldMap = (mapId) => {
    return /world/.test(mapId);
  }

  const sampleParty = () => {
    return [{
      charClass: 'WM',
      name: 'AAAA',
      weapons: [], armor: [], spells: []
    }, {
      charClass: 'Th',
      name: 'BBBB',
      weapons: [], armor: [], spells: []
    }, {
      charClass: 'BB',
      name: 'CCCC',
      weapons: [], armor: [], spells: []
    }, {
      charClass: 'RM',
      name: 'DDDD',
      weapons: [], armor: [], spells: []
    }];
  }

  const updateArray = (array, index, update) => {
    return array.map((item, i) => {
      if (i !== index) {
        return item;
      }
      return Object.assign({}, item, update);
    });
  }

  const reducer = (state, action) => {
    if (!state) return initialState;

    let party;
    let movingBuffer;
    let startPosition;
    let newState = {};

    switch (action.type) {
      case 'CHAR_CLASS_SET':
        newState.party = state.party.slice();
        newState.party.push({ charClass: action.charClass });
        newState.movableId = newState.party[0].charClass
        return Object.assign({}, state, newState);
      case 'CHAR_NAME_SET':
        return Object.assign({}, state, {
          party: updateArray(state.party, state.party.length - 1, { name: action.name })
        })
      case 'LOAD_GAME':
        console.log('TODO: load state from actual saved game');
        newState.party = sampleParty();
        newState.movableId = newState.party[0].charClass
        return Object.assign({}, state, newState);
      case 'MAP_LOADED':
        return Object.assign({}, state, { map: action.map });
      case 'MAP_TRANSITION':
        if (isWorldMap(state.mapId)) {
          newState.worldMapPosition = {
            x: state.position.x,
            y: state.position.y
          };
        }
        if (!action.transition.shop) {
          newState.mapId = action.transition.map;
        }
        debugger;
        return Object.assign({}, state, newState);
      case 'MOVING':
        newState.moving = state.moving.slice();
        if (newState.moving.length < 2) {
          newState.moving.push(action.moving);
        }
        return Object.assign({}, state, newState);
      case 'POSITION_CHANGED':
        return Object.assign({}, state, {
          position: { x: action.x, y: action.y }
        });
      case 'SCREEN_CHANGED':
        return Object.assign({}, state, { screen: action.payload });
      case 'START_GAME':
        newState.mapId = 'world';
        newState.position = Object.assign({}, state.position);
        if (newState.position.x < 0 || newState.position.y < 0) {
          newState.position.x = state.worldMapPosition.x;
          newState.position.y = state.worldMapPosition.y;
        }
        return Object.assign({}, state, newState);
      case 'STOP_MOVING':
        newState.moving = state.moving.slice();
        newState.moving.shift();
        return Object.assign({}, state, newState);
      case 'STORE_WORLD_MAP_POSITION':
        newState.worldMapPosition.x = action.x;
        newState.worldMapPosition.y = action.y;
        return Object.assign({}, state, newState);
      case 'VEHICLE_CHANGE':
        // TODO: handle this
      default:
        return state;
    }
  };

  const store = Redux.createStore(reducer, initialState);
  ReduxMixin = PolymerRedux(store);
})();
</script>