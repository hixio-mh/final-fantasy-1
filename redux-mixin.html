<link rel="import" href="/bower_components/polymer-redux/polymer-redux.html">
<script src="/node_modules/redux/dist/redux.js"></script>

<script>
const initialState = {
  map: null,
  movableId: '',
  moving: [],
  party: [],
  partyVehicles: ['Foot'],
  position: { x: 153, y: 165 },
  screen: 'openingMenu',
  vehicle: 'Foot',
  vehiclePositions: {
    Ship: { x: -1, y: -1 },
    Airship: { x: -1, y: -1 }
  },
  worldMapPosition: { x: 153, y: 165 }
};

const sampleParty = () => {
  return [{
    charClass: 'WM',
    name: 'AAAA',
    weapons: [], armor: [], spells: []
  }, {
    charClass: 'Th',
    name: 'BBBB',
    weapons: [], armor: [], spells: []
  }, {
    charClass: 'BB',
    name: 'CCCC',
    weapons: [], armor: [], spells: []
  }, {
    charClass: 'RM',
    name: 'DDDD',
    weapons: [], armor: [], spells: []
  }];
}

const updateArray = (array, index, update) => {
  return array.map((item, i) => {
    if (i !== index) {
      return item;
    }
    return Object.assign({}, item, update);
  });
}

const reducer = (state, action) => {
  if (!state) return initialState;

  let party;
  let movingBuffer;

  switch (action.type) {
    case 'CHAR_CLASS_SET':
      party = state.party.slice();
      party.push({ charClass: action.charClass });
      return Object.assign({}, state, {
        party: party,
        movableId: party[0].charClass
      });
    case 'CHAR_NAME_SET':
      return Object.assign({}, state, {
        party: updateArray(state.party, state.party.length - 1, { name: action.name })
      })
    case 'LOAD_GAME':
      console.log('TODO: load from actual saved game');
      party = sampleParty();
      return Object.assign({}, state, {
        party: party,
        movableId: party[0].charClass
      });
    case 'MAP_LOADED':
      return Object.assign({}, state, { map: action.map });
    case 'MOVING':
      movingBuffer = state.moving.slice();
      if (movingBuffer.length < 2) {
        movingBuffer.push(action.moving);
      }
      return Object.assign({}, state, { moving: movingBuffer });
    case 'POSITION_CHANGED':
      return Object.assign({}, state, {
        position: { x: action.x, y: action.y }
      });
    case 'SCREEN_CHANGED':
      return Object.assign({}, state, { screen: action.payload });
    case 'START_GAME':
      return state;
    case 'STOP_MOVING':
      movingBuffer = state.moving.slice();
      movingBuffer.shift();
      return Object.assign({}, state, { moving: movingBuffer });
    case 'STORE_WORLD_MAP_POSITION':
      return Object.assign({}, state, {
        worldMapPosition: {
          x: action.x,
          y: action.y
        }
      });
    case 'VEHICLE_CHANGE':
      // TODO: handle this
    default:
      return state;
  }
};

const store = Redux.createStore(reducer, initialState);
ReduxMixin = PolymerRedux(store);
</script>